
A) Connect your on-premises network to Azure with VPN Gateway

1) Create the Azure-side resources

1.1) Create the Azure-VNet-1 virtual network and the Services subnet:

az network vnet create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name Azure-VNet-1 --address-prefixes 10.0.0.0/16 --subnet-name Services --subnet-prefixes 10.0.0.0/24


1.2) Add the GatewaySubnet subnet to Azure-VNet-1:

az network vnet subnet create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --vnet-name Azure-VNet-1 --address-prefixes 10.0.255.0/27 --name GatewaySubnet


1.3) Create the LNG-HQ-Network local network gateway:

az network local-gateway create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --gateway-ip-address 94.0.252.160 --name LNG-HQ-Network --local-address-prefixes 172.16.0.0/16

2) Create the simulated on-premises network and supporting resources

2.1) Create the HQ-Network virtual network and the Applications subnet:

az network vnet create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name HQ-Network --address-prefixes 172.16.0.0/16 --subnet-name Applications --subnet-prefixes 172.16.0.0/24

2.2) Add GatewaySubnet to HQ-Network:

az network vnet subnet create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --address-prefixes 172.16.255.0/27 --name GatewaySubnet --vnet-name HQ-Network

2.3) Create the LNG-Azure-VNet-1 local network gateway:

az network local-gateway create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --gateway-ip-address 94.0.252.160 --name LNG-Azure-VNet-1 --local-address-prefixes 172.16.255.0/27

3) Verify the topology

3.1) Verify that the virtual networks have been successfully created:

az network vnet list --output table

3.2) Verify that the local network gateways have been successfully created:

az network local-gateway list --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --output table


B) Create a site-to-site VPN gateway

1) Create the Azure-side VPN gateway

1.1) Create the PIP-VNG-Azure-VNet-1 public IP address:

az network public-ip create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name PIP-VNG-Azure-VNet-1 --allocation-method Dynamic

1.2) Create the VNG-Azure-VNet-1 virtual network:

az network vnet create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name VNG-Azure-VNet-1 --subnet-name GatewaySubnet

1.3) Create the VNG-Azure-VNet-1 virtual network gateway:

az network vnet-gateway create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name VNG-Azure-VNet-1 --public-ip-addresses PIP-VNG-Azure-VNet-1 --vnet VNG-Azure-VNet-1 --gateway-type Vpn --vpn-type RouteBased --sku VpnGw1 --no-wait

2) Create the on-premises VPN gateway

2.1) Create the PIP-VNG-HQ-Network public IP address:

az network public-ip create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name PIP-VNG-HQ-Network --allocation-method Dynamic

2.2) Create the VNG-HQ-Network virtual network:

az network vnet create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name VNG-HQ-Network --subnet-name GatewaySubnet

2.3) Create the VNG-HQ-Network virtual network gateway:

az network vnet-gateway create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name VNG-HQ-Network --public-ip-addresses PIP-VNG-HQ-Network --vnet VNG-HQ-Network --gateway-type Vpn --vpn-type RouteBased --sku VpnGw1 --no-wait

2.4) Use Linux watch command to monitor the progress:

watch -d -n 5 az network vnet-gateway list --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --output table

2.5) After each VPN gateway shows a ProvisioningState of Succeeded, you're ready to continue. Press Ctrl+C to halt the command after the gateway is created.


3) Update the local network gateway IP references

3.1) Check whether both virtual network gateways have been created. The initial state will show Updating. You want to see Succeeded on both VNG-Azure-VNet-1 and VNG-HQ-Network:

az network vnet-gateway list --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --output table

3.2) Retrieve the IPv4 address assigned to PIP-VNG-Azure-VNet-1 and store it in a variable:

PIPVNGAZUREVNET1=$(az network public-ip show --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name PIP-VNG-Azure-VNet-1 --query "[ipAddress]" --output tsv)

3.3) Update the LNG-Azure-VNet-1 local network gateway so that it points to the public IP address attached to the VNG-Azure-VNet-1 virtual network gateway:

az network local-gateway update --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name LNG-Azure-VNet-1 --gateway-ip-address $PIPVNGAZUREVNET1

3.4) Retrieve the IPv4 address assigned to PIP-VNG-HQ-Network and store it in a variable:

PIPVNGHQNETWORK=$(az network public-ip show --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name PIP-VNG-HQ-Network --query "[ipAddress]" --output tsv)

3.5) Update the LNG-HQ-Network local network gateway so that it points to the public IP address attached to the VNG-HQ-Network virtual network gateway:

az network local-gateway update --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name LNG-HQ-Network --gateway-ip-address $PIPVNGHQNETWORK


4) Create the connections

4.1) Create the shared key to use for the connections. In the following command, replace <shared key> with a text string to use for the IPSec pre-shared key. The pre-shared key is a string of printable ASCII characters no longer than 128 characters. It cannot contain special characters, like hyphens and tildes. You'll use this pre-shared key on both connections:

SHAREDKEY=01234567891234567890

4.2) Remember that LNG-HQ-Network contains a reference to the IP address on your simulated on-premises VPN device. Create a connection from VNG-Azure-VNet-1 to LNG-HQ-Network:

az network vpn-connection create --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name Azure-VNet-1-To-HQ-Network --vnet-gateway1 VNG-Azure-VNet-1 --shared-key $SHAREDKEY --local-gateway2 LNG-HQ-Network


5) Verification Steps

5.1) Confirm that Azure-VNet-1-To-HQ-Network is connected:

az network vpn-connection show --resource-group learn-5114d638-33d4-4fb1-a676-f49db0b657fe --name Azure-VNet-1-To-HQ-Network --output table --query '{Name:name,ConnectionStatus:connectionStatus}'





